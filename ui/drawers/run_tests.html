<!-- Run Tests Drawer -->
<div class="drawer-header">
    <h2>üß™ Quality Tests</h2>
    <button onclick="closeDebugDrawer()" class="close-btn">‚úï</button>
</div>

<div class="drawer-content">
    <div class="flex justify-between items-center mb-6">
        <p class="text-gray-400 text-sm">Automated tests to verify improvements are working</p>
        <button onclick="runQualityTests()" id="run-tests-btn" class="run-tests-btn">
            ‚ñ∂Ô∏è Run Tests
        </button>
    </div>

    <!-- Results Summary -->
    <div id="test-summary" class="test-summary hidden">
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-value" id="test-total">0</div>
                <div class="summary-label">Total</div>
            </div>
            <div class="summary-item bg-green-900/20 border-green-700">
                <div class="summary-value text-green-400" id="test-passed">0</div>
                <div class="summary-label">Passed</div>
            </div>
            <div class="summary-item bg-red-900/20 border-red-700">
                <div class="summary-value text-red-400" id="test-failed">0</div>
                <div class="summary-label">Failed</div>
            </div>
            <div class="summary-item bg-yellow-900/20 border-yellow-700">
                <div class="summary-value text-yellow-400" id="test-warned">0</div>
                <div class="summary-label">Warnings</div>
            </div>
        </div>
        <div class="pass-rate-bar">
            <div class="pass-rate-label">Pass Rate</div>
            <div class="pass-rate-value" id="test-pass-rate">0%</div>
            <div class="w-full bg-gray-700 h-2 rounded-full mt-2">
                <div id="test-pass-bar" class="h-2 rounded-full transition-all duration-500 bg-green-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Test Results -->
    <div id="test-results" class="mt-6">
        <p class="text-gray-500 italic text-center py-8">Click "Run Tests" to verify improvements</p>
    </div>
</div>

<script>
async function runQualityTests() {
    const btn = document.getElementById('run-tests-btn');
    const resultsContainer = document.getElementById('test-results');
    const summaryContainer = document.getElementById('test-summary');
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Running...';
    resultsContainer.innerHTML = '<div class="text-center py-8 text-gray-400">Running tests...</div>';
    summaryContainer.classList.add('hidden');
    
    try {
        const res = await fetch('/run_tests');
        const data = await res.json();
        
        // Update summary
        document.getElementById('test-total').textContent = data.total || 0;
        document.getElementById('test-passed').textContent = data.passed || 0;
        document.getElementById('test-failed').textContent = data.failed || 0;
        document.getElementById('test-warned').textContent = data.warned || 0;
        
        const passRate = data.pass_rate || 0;
        document.getElementById('test-pass-rate').textContent = `${passRate.toFixed(1)}%`;
        document.getElementById('test-pass-bar').style.width = `${passRate}%`;
        
        summaryContainer.classList.remove('hidden');
        
        // Render test results
        let html = '<div class="space-y-2">';
        
        if (data.results && data.results.length > 0) {
            data.results.forEach(test => {
                let badgeColor = 'gray';
                let badgeText = test.result;
                
                if (test.result.includes('PASS')) {
                    badgeColor = 'green';
                } else if (test.result.includes('FAIL')) {
                    badgeColor = 'red';
                } else if (test.result.includes('WARN')) {
                    badgeColor = 'yellow';
                }
                
                html += `
                    <div class="test-result-card">
                        <div class="flex items-start gap-3">
                            <span class="test-badge badge-${badgeColor}">${badgeText}</span>
                            <div class="flex-1">
                                <div class="test-name">${test.name}</div>
                                <div class="test-details">${test.details}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            html += '<p class="text-gray-500 italic text-center py-4">No test results</p>';
        }
        
        html += '</div>';
        resultsContainer.innerHTML = html;
        
    } catch (error) {
        resultsContainer.innerHTML = `
            <div class="bg-red-900/20 border border-red-700 rounded-lg p-4">
                <div class="text-red-400 font-bold mb-2">Error Running Tests</div>
                <div class="text-sm text-gray-300">${error.message}</div>
            </div>
        `;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '‚ñ∂Ô∏è Run Tests';
    }
}

// No auto-refresh for tests (user-initiated only)
function startRunTestsRefresh() {
    // No-op - tests are manual
}

function stopRunTestsRefresh() {
    // No-op
}
</script>