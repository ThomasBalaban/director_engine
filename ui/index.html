<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nami's Brain</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <link rel="stylesheet" href="style.css">
</head>

<body class="h-screen overflow-hidden flex flex-col p-4 md:p-6 lg:p-8">
    <div class="max-w-screen-2xl mx-auto w-full flex flex-col flex-1 min-h-0">
        <header class="mb-4 flex-shrink-0">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-3xl font-bold text-white">Director Engine <span class="text-sm font-medium text-gray-400">| Context Monitor</span></h1>
                <div class="flex gap-3">
                    <div id="state-pill" class="px-4 py-2 border-2 border-gray-600 bg-gray-800 rounded-full font-bold text-lg flex items-center gap-2">
                        <span>üó£Ô∏è</span> <span id="state-text">IDLE</span>
                    </div>
                    <div id="mood-pill" class="px-4 py-2 border-2 rounded-full font-bold text-lg mood-Neutral flex items-center gap-2">
                        <span>üé≠</span> <span id="mood-text">Neutral</span>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Director Controls Bar -->
            <div class="flex gap-4 items-center bg-[#2a2a2a] border border-[#444] rounded-lg p-3">
                <!-- Streamer Dropdown -->
                <div class="flex items-center gap-2">
                    <label for="streamer-select" class="text-sm text-gray-400 whitespace-nowrap">üì∫ Watching:</label>
                    <select id="streamer-select" class="bg-[#1a1a1a] border border-[#555] rounded px-3 py-1.5 text-white text-sm focus:outline-none focus:border-purple-500">
                        <option value="peepingotter">PeepingOtter</option>
                    </select>
                </div>
                
                <!-- Context Input -->
                <div class="flex items-center gap-2 flex-1">
                    <label for="context-input" class="text-sm text-gray-400 whitespace-nowrap">üìù Context:</label>
                    <input 
                        type="text" 
                        id="context-input" 
                        placeholder="e.g., Otter is currently playing Phasmophobia..."
                        class="flex-1 bg-[#1a1a1a] border border-[#555] rounded px-3 py-1.5 text-white text-sm placeholder-gray-500 focus:outline-none focus:border-purple-500"
                    >
                    <button id="context-submit" class="bg-purple-600 hover:bg-purple-700 px-4 py-1.5 rounded text-sm font-medium transition-colors">
                        Set
                    </button>
                </div>
                
                <!-- Current Context Display -->
                <div id="current-context-display" class="text-xs text-gray-500 max-w-xs truncate hidden">
                    <span class="text-gray-400">Active:</span> <span id="active-context-text"></span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 flex-1 min-h-0">
            
            <div class="flex flex-col gap-6 min-h-0">
                
                <div id="directive-panel" class="panel flex-none min-h-0 bg-gradient-to-b from-[#2a2a2a] to-[#202020] border-purple-900/50">
                    <h2 class="panel-title text-purple-300 border-b border-purple-900/30">‚ö° Director's Orders</h2>
                    <div class="panel-content flex flex-col gap-3">
                        <div>
                            <div class="text-[10px] uppercase tracking-widest text-gray-500 font-bold">Objective</div>
                            <div id="dir-objective" class="text-lg font-bold text-white leading-tight">Waiting...</div>
                        </div>
                        <div>
                            <div class="text-[10px] uppercase tracking-widest text-gray-500 font-bold">Required Tone</div>
                            <div id="dir-tone" class="text-sm text-purple-200">Waiting...</div>
                        </div>
                        <div>
                            <div class="text-[10px] uppercase tracking-widest text-gray-500 font-bold">Action</div>
                            <div id="dir-action" class="text-sm text-gray-300 italic">Waiting...</div>
                        </div>
                        <div id="dir-constraints-box" class="hidden p-2 bg-red-900/20 border border-red-900/50 rounded">
                             <div class="text-[10px] uppercase tracking-widest text-red-400 font-bold">Constraints</div>
                             <div id="dir-constraints" class="text-xs text-red-200"></div>
                        </div>
                    </div>
                </div>

                <div id="summary-panel" class="panel h-1/3 min-h-0">
                    <h2 class="panel-title">üß† Situation Summary</h2>
                    <div class="panel-content">
                        <div class="summary-text" id="summary-text">Waiting for summary...</div>
                        <div class="summary-raw-context" id="summary-raw-context">Raw context...</div>
                    </div>
                </div>
                
                <div id="interest-graph-panel" class="panel flex-1 min-h-0">
                    <h2 class="panel-title">üìà Interest Graph</h2>
                    <div class="panel-content flex flex-col">
                        <div class="flex-1 relative" style="width:100%; min-height: 120px;"> 
                            <canvas id="interest-chart"></canvas>
                        </div>
                        <pre id="graph-data-log" class="text-xs text-gray-400 flex-none h-32 overflow-y-auto pt-2 border-t border-gray-700 mt-2">
[Waiting for scores...]</pre>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-6 min-h-0">
                <div class="panel flex-1 min-h-0">
                    <h2 class="panel-title">üëÅÔ∏è Vision (12s)</h2>
                    <div class="panel-content">
                        <div id="vision-context" class="context-box text-xs text-gray-300">Waiting...</div>
                    </div>
                </div>
                <div class="panel flex-1 min-h-0">
                    <h2 class="panel-title">üé§ Speech (30s)</h2>
                    <div class="panel-content">
                        <div id="spoken-word-context" class="context-box text-xs text-gray-300">Waiting...</div>
                    </div>
                </div>
                <div class="panel flex-1 min-h-0">
                    <h2 class="panel-title">üîä Audio (12s)</h2>
                    <div class="panel-content">
                        <div id="audio-context" class="context-box text-xs text-gray-300">Waiting...</div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-6 min-h-0">
                <div class="panel flex-1 min-h-0">
                    <h2 class="panel-title">üí¨ Chat</h2>
                    <div id="twitch-messages" class="panel-content text-sm log-list"></div>
                </div>
                <div class="panel flex-1 min-h-0">
                    <h2 class="panel-title">ü§ñ Nami's Brain</h2>
                    <div id="nami-replies" class="panel-content text-sm log-list"></div>
                </div>
            </div>

            <div class="flex flex-col gap-6 min-h-0">
                
                <div id="metrics-panel" class="panel flex-none min-h-0">
                    <h2 class="panel-title flex justify-between">
                        <span>üéõÔ∏è Brain Metrics</span>
                        <span id="adaptive-state-label" class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">Initializing</span>
                    </h2>
                    <div class="panel-content space-y-4">
                        <div>
                            <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span>Social Battery</span>
                                <span id="battery-value">100%</span>
                            </div>
                            <div class="w-full bg-gray-800 h-2 rounded-full overflow-hidden">
                                <div id="battery-bar" class="h-full bg-green-500 transition-all duration-500" style="width: 100%"></div>
                            </div>
                        </div>

                        <div class="border-t border-gray-700 pt-3">
                             <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span>Attention Threshold</span>
                                <span id="threshold-value">0.90</span>
                            </div>
                            <div class="w-full bg-gray-800 h-2 rounded-full overflow-hidden">
                                <div id="threshold-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 90%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                    <span>Velocity</span>
                                    <span id="velocity-value">0/m</span>
                                </div>
                                <div class="w-full bg-gray-800 h-2 rounded-full overflow-hidden">
                                    <div id="velocity-bar" class="h-full bg-purple-500 transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                    <span>Hype</span>
                                    <span id="energy-value">0.0</span>
                                </div>
                                <div class="w-full bg-gray-800 h-2 rounded-full overflow-hidden">
                                    <div id="energy-bar" class="h-full bg-yellow-500 transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dynamics-panel" class="panel flex-none min-h-0">
                    <h2 class="panel-title">üåä Flow Dynamics</h2>
                    <div class="panel-content grid grid-cols-2 gap-4">
                         <div>
                            <div class="text-xs text-gray-500 uppercase font-bold mb-1">Current Flow</div>
                            <div id="flow-text" class="text-sm font-medium text-blue-300 truncate">Reading...</div>
                         </div>
                         <div>
                            <div class="text-xs text-gray-500 uppercase font-bold mb-1">User Intent</div>
                            <div id="intent-text" class="text-sm font-medium text-purple-300 truncate">Reading...</div>
                         </div>
                    </div>
                </div>

                <div id="prediction-panel" class="panel flex-none min-h-0">
                    <h2 class="panel-title">üîÆ Anticipation</h2>
                    <div class="panel-content bg-[#252525]">
                        <p id="prediction-text" class="prediction-text text-sm text-gray-300 italic">Observing flow...</p>
                    </div>
                </div>

                <div id="user-panel" class="panel flex-none min-h-0">
                    <h2 class="panel-title">üë§ Active User</h2>
                    <div class="panel-content" id="user-content">
                        <p class="text-gray-500 italic text-sm text-center">No active user context.</p>
                    </div>
                </div>

                <div id="memory-panel" class="panel flex-1 min-h-0">
                    <h2 class="panel-title">üíæ Memories</h2>
                    <div class="panel-content">
                        <ul id="memory-list" class="space-y-3">
                            <li class="text-gray-500 italic text-sm text-center">Waiting for highlights...</li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <div id="context-drawer-overlay" class="fixed inset-0 bg-black/50 hidden z-40" onclick="closeDrawer()"></div>
    <aside id="context-drawer" class="fixed top-0 right-0 h-screen w-full max-w-md translate-x-full transition-transform duration-200 ease-out bg-[#2a2a2a] border-l border-[#444] shadow-xl flex flex-col z-50">
        <div class="p-3 border-b border-[#444] flex justify-between items-center">
            <h3 class="text-sm font-semibold text-white">Nami Prompt Details</h3>
            <button onclick="closeDrawer()" class="text-gray-400 hover:text-white">‚úï</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <div class="mb-4"><h4 class="text-gray-400 text-xs uppercase mb-1">Prompt</h4><pre id="drawer-sent" class="bg-[#111] p-2 text-sm text-gray-300 whitespace-pre-wrap rounded border border-[#333]"></pre></div>
            <div><h4 class="text-gray-400 text-xs uppercase mb-1">Response</h4><pre id="drawer-reply" class="bg-[#111] p-2 text-sm text-gray-300 whitespace-pre-wrap rounded border border-[#333]"></pre></div>
        </div>
    </aside>

    <script src="script.js?v=3"></script>
    <script>
        // --- Director Controls Logic ---
        
        // Load streamers from JSON
        async function loadStreamers() {
            try {
                const response = await fetch('/static/streamers.json');
                const data = await response.json();
                const select = document.getElementById('streamer-select');
                
                // Clear existing options
                select.innerHTML = '';
                
                // Add options from JSON
                data.streamers.forEach(streamer => {
                    const option = document.createElement('option');
                    option.value = streamer.id;
                    option.textContent = streamer.display_name;
                    select.appendChild(option);
                });
                
                // Set default to peepingotter
                select.value = 'peepingotter';
                
                // Send initial selection to server
                updateStreamerContext(select.value);
            } catch (error) {
                console.error('Failed to load streamers:', error);
            }
        }
        
        // Update streamer context on server
        function updateStreamerContext(streamerId) {
            socket.emit('set_streamer', { streamer_id: streamerId });
            console.log('[Director] Set streamer to:', streamerId);
        }
        
        // Update manual context on server
        function updateManualContext(contextText) {
            socket.emit('set_manual_context', { context: contextText });
            
            // Show active context indicator
            const display = document.getElementById('current-context-display');
            const textEl = document.getElementById('active-context-text');
            
            if (contextText.trim()) {
                textEl.textContent = contextText;
                display.classList.remove('hidden');
            } else {
                display.classList.add('hidden');
            }
            
            console.log('[Director] Set manual context:', contextText);
        }
        
        // Event listeners
        document.getElementById('streamer-select').addEventListener('change', (e) => {
            updateStreamerContext(e.target.value);
        });
        
        document.getElementById('context-submit').addEventListener('click', () => {
            const input = document.getElementById('context-input');
            updateManualContext(input.value);
        });
        
        document.getElementById('context-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                updateManualContext(e.target.value);
            }
        });
        
        // Load streamers on page load
        loadStreamers();
    </script>
</body>
</html>